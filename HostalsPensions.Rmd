---
title: "Allotjaments en Hostal i Pensions - AAI - Aj.BCN"
author: "Ajuntament de Barcelona - AAI - Dolors Maynou (mmaynou@bcn.cat) i Xavier de Pedro (xdepedro@bcn.cat)"
date: "Abril 2018 - ..."
output:
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# Set overall timer to zero
start_all <- Sys.time()
```

## Allotjaments en Hostal i Pensions - AAI - Aj.BCN

Resultats destacats a partir de les dades d'Allotjaments en Hostals i Pensions d'Immigrants i Refugiats de Barcelona, finançat a través de la Direcció d'Atenció i Acollida d'Immigrants de l'Ajuntament de Barcelona.

```{r paquets, echo=TRUE}
if (!require("checkpoint")) install.packages("checkpoint"); library(checkpoint)
checkpoint("2018-03-16") # Keep R packages from this date for reproducibility
# https://www.r-bloggers.com/updated-checkpoint-package-faster-reproducibility-with-more-feedback/
# https://www.r-bloggers.com/new-features-in-the-checkpoint-package-version-0-4-0/

if (!require("pacman")) install.packages("pacman")
#pacman::p_load_gh("trinker/textreadr")

pacman::p_load(leaflet.minicharts); library(leaflet.minicharts)
#devtools::install_github("rstudio/crosstalk")
#devtools::install_github("rstudio/leaflet")
#devtools::install_github("jcheng5/d3scatter")

if (!require("readxl")) install.packages("readxl"); library(readxl)
if (!require("dplyr")) install.packages("dplyr"); library(dplyr)
if (!require("stringr")) install.packages("stringr"); library(stringr)
if (!require("tidyimpute")) install.packages("tidyimpute"); library(tidyimpute)

# Allowi also Ploting Maps Using rworldmap
# Derived from: https://blog.learningtree.com/how-to-display-data-on-a-world-map-in-r/
  if (!require("rworldmap")) install.packages("rworldmap"); library(rworldmap)

  
  # More libraries
  if (!require("devtools")) install.packages("devtools"); library(devtools)
  ##if (!require("ggplot2")) install.packages("ggplot2"); library(ggplot2)
  ## Or install the dev version to take the most of ggplotly() function
  if (!require("ggplot2")) devtools::install_github('hadley/ggplot2'); library(ggplot2)
  # See awesome top 50 ggplot chart list at: http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html
  if (!require("plotly")) install.packages("plotly"); library(plotly)
  if (!require("treemap")) install.packages("treemap"); library(treemap)
  if (!require("d3treeR")) devtools::install_github("timelyportfolio/d3treeR"); library(d3treeR)
  if (!require("networkD3")) install.packages("networkD3"); library(networkD3)

# Add package widget frame so that we attempt to get responsive iframes produced by htmlwidgets such as theones from rpivotTable
# See: https://github.com/bhaskarvk/widgetframe
if(!require("widgetframe")){ install.packages("widgetframe") }; require(widgetframe)
if(!require("htmlwidgets")){ install.packages("htmlwidgets") }; require(htmlwidgets) 
if(!require("rpivotTable")){ install.packages("rpivotTable") }; require(rpivotTable)
if(!require("formattable")){ install.packages("formattable") }; require(formattable)
if(!require("DT")){ install.packages("DT") }; require(DT)

if(!require("rvest")){ install.packages("rvest") }; require(rvest)
if(!require("magick")){ install.packages("magick") }; require(magick) # See: https://cran.r-project.org/web/packages/magick/vignettes/intro.html
if(!require("svglite")){ install.packages("svglite") }; require(svglite) # See: https://www.opencpu.org/posts/svg-release/
if(!require("rsvg")){ install.packages("rsvg") }; require(rsvg) # See: https://www.opencpu.org/posts/svg-release/

# Add webshot to allos making screenshots from htmlwidgets for printed versions of reports
if(!require("webshot")){ install.packages("webshot") }; require(webshot)
# Install also phantomjs thorugh webshot as a required dependency (only once)
#webshot::install_phantomjs(baseURL = "https://bitbucket.org/ariya/phantomjs/downloads/")

# Libraries to allow adding svgPanZoom capabilities to standard Plots
# See: https://github.com/timelyportfolio/svgPanZoom
if (!require("svgPanZoom")) devtools::install_github("timelyportfolio/svgPanZoom"); library(svgPanZoom) # see install step above
if (!require("svglite")) install.packages("svglite"); library(svglite)

# Libraries to allow runing processes in parallel where possible, and allow profiling to detect slow steps
if (!require("parallel")) install.packages("parallel"); library(parallel)
if (!require("doParallel")) install.packages("doParallel"); library(doParallel)
if (!require("foreach")) install.packages("foreach"); library(foreach)
if (!require("profvis")) install.packages("profvis"); library(profvis)

# =======================================================
# Pending-0
# =======================================================
# Si volguessim convertir l'output en un document de Word, podríem emprar:
## ReporteRs (requereix rJava, i no es desenvoluparà més, perquè l'autor ha fet OfficeR després, que no repen de rJava). 
##   Veure: http://www.sthda.com/english/wiki/create-and-format-word-documents-using-r-software-and-reporters-package 
##
##  OfficeR (NO requereix rJava, i fet pel mateix autor que ReporteRs). 
##   Veure: https://davidgohel.github.io/officer/ 
if (!require("officer")) install.packages("officer"); library(officer) # https://davidgohel.github.io/officer/
if (!require("magrittr")) install.packages("magrittr"); library(magrittr) # Package `magrittr` makes officer usage easier.
if (!require("flextable")) install.packages("flextable"); library(flextable)
if (!require("mschart")) install.packages("mschart"); library(mschart)
##
## o
##
## Pandoc
##   Veure: https://www.r-statistics.com/2013/03/write-ms-word-document-using-r-with-as-little-overhead-as-possible/
## o
##
## WordR i afins
##   Veure: https://rviews.rstudio.com/2017/10/04/wordr---a-new-r-package-for-rendering-documents-in-ms-word-format/
##          
```

```{r paràmetres inicials}
#Paràmetre per controlar l'any (anydades)
anydades <- "2018"

#Paths
htmlpath      <- "Html"; dir.create(htmlpath, recursive = TRUE, showWarnings = FALSE)
imgpath       <- "Grafics"; dir.create(imgpath, recursive = TRUE, showWarnings = FALSE)
templatepath  <- "Plantilles"; dir.create(templatepath, recursive = TRUE, showWarnings = FALSE)
docpath       <- "Informes"; dir.create(docpath, recursive = TRUE, showWarnings = FALSE)
logspath      <- "Logs"; dir.create(logspath, recursive = TRUE, showWarnings = FALSE)

# WorkFlow control
# ----------------
# Paràmetres per a controlar quines parts del codi s'executen en cada run.
#
runParam <- T

# Crear addicionalment arxius html parcials amb gràfics interactius (opcional)
crear.html.pt.membres.t <- runParam
crear.html.leaflet.agegroups <- runParam
crear.html.ggplotly.nacionalitat <- runParam
crear.html.pnacio.i <- F # runParam
crear.html.leaflet.gender <- runParam
crear.html.pt.regim.allotjament.t <- runParam
crear.html.pt.durada.t <- runParam
crear.html.dt.regim.allotjament.month <- runParam
crear.html.dt.motiu <- runParam
crear.html.dt.origens.menors <- runParam
crear.html.pt.despesa.t <- runParam

runParam <- T

# Crear addicionalment arxius png en disc amb gràfics per separat (opcional)
crear.png.ggplot.nacionalitat <- runParam
crear.png.ggplot.motiu <- runParam
crear.png.ggplot.barchart.n.mes <- runParam
crear.png.ggplot.nacio.menors <- runParam
crear.png.ggplot.regim.allotjament <- runParam
crear.png.ggplot.pais.tramit.ue <- runParam
crear.png.ggplot.perfils <- runParam
crear.png.ggplot.dec.majoria.edat <- runParam
crear.png.ggplot.n.mes.saier <- runParam

runParam <- T

# Mostrar gràfics per pantalla addicionalment (opcional)
mostrar.html.pt.membres.t <- runParam
mostrar.pnacio.i <- F #runParam
mostrar.html.ggplot.n.mes <- runParam
mostrar.html.ggplot.nacio.menors <- runParam
mostrar.html.leaflet.gender <- runParam
mostrar.ggplot.sa <- runParam
mostrar.html.pt.regim.allotjament.t <- runParam
mostrar.html.pt.durada.t <- runParam
mostrar.png.ggplot.pais.tramit.ue <- runParam
mostrar.ggplot.perfils <- runParam
mostrar.ggplot.dec.majoria.edat <- runParam
mostrar.html.pt.despesa.t <- runParam

runParam <- T

# Crear informe en arxiu de Microsoft Word (.docx) en disc
crear.informe.word <- runParam

```

```{r Codi per a la Paral·lelització eventual de la feina}
ncores <- detectCores(logical = FALSE) # nombre de cores físics (no logics), en Windows
# ncores
# 4
nCoresToUse <- 1 # default value, to be overriden by allcores -1 only when there is more than two cores in the machine
if (ncores > 2) nCoresToUse <- ncores - 1 # all minus one (to keep computer responsive while computing also)
# ThinkCentre-Computers at Ajuntament de Barcelona have 4 cores ! :-)
cl <- makeCluster(nCoresToUse) # create a cluster with all cores indicated
registerDoParallel(cl) # register the cluster
# Remember to use "foreach"" package for loops (with %dopar%, see example below) to get performance improvements due to parallel execution of threads
# and parLapply to get parallel apply on Windows also 
# See https://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf

## Example, collecting return values from the parallel execution of the loop in a matrix of 10 rows:
# matrix<-foreach(i=1:10,.combine=rbind) %dopar% {
#   i
# }

```


```{r Inici informe en word}
if (crear.informe.word == TRUE) {
  
  require(officer)
  require(magrittr)
  
  my_doc <- read_docx(path=file.path(getwd(), templatepath, "Word_AAI_template_v03.docx") )
  #my_doc <- read_docx()
  # styles_info(my_doc)
  
  my_doc <- my_doc %>% 
    body_add_par(value = paste0("Allotjaments en Hostal i Pensions (", anydades, ")"), style = "Title") %>% 
    body_add_par(value = "Índex:", style = "Normal") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_toc(level = 3) 
  
}

```

```{r Lectura i pre-processat dades, echo=TRUE}
# -----------
# Source Data
# -----------

my_file <- file.path("K:\\QUOTA\\DIMM_COMU\\SAIER\\Hostals\ i\ Pensions\\2018\\Estades\ reals", "BD_Estades_Hostals_Pensions_v03.xlsx")
#my_file <- file.path(".", "bbdd_urgencies_saier_demo.xlsx")

# Read From xlsx sheet
# ..............................
# Option 1: readxl package
# ..............................
# From http://www.sthda.com/english/wiki/reading-data-from-excel-files-xls-xlsx-into-r
# The readxl package, developed by Hadley Wickham, can be used to easily import Excel files (xls|xlsx) into R without any external dependencies.

#Specify sheet with a number or name
# Specify sheet by its name
my_data <- read_excel(my_file, sheet = "Dades")
head(my_data)
#my_data <- my_data %>% 
#  filter(Categoria == "Refus-P" | Categoria == "Refus-FP") %>%
#  filter(Categoria == "Immis") %>%
#  filter(Mes == "MARÇ") 
#colnames(my_data)


geodata <- read_excel(my_file, sheet = "PaisesContinentes")

# Summarise data based on Country of origin
my_data4 <- count(my_data, NacionalitatAngles, Mes, AdultMenor, Genere, wt = NULL, sort = FALSE)
#colnames(my_data4)
my_data4$NacionalitatAngles <- apply(my_data4, 2, toupper)
#head(my_data4)
#dim(my_data4)

#colnames(geodata)[7] <- "NacionalitatAngles"
#colnames(geodata)
#head(geodata)
#dim(geodata)

# Add coordinates to the countries from the Dades sheet, using left_join
my_data5 <- my_data4 %>% left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles"))

my_data5b <- my_data5 %>%
  # filter(grepl("EUROPA", Continent)) %>%
  select(NacionalitatAngles,
         Mes,
         AdultMenor,
         Genere,
         n,
         lon,
         lat,
         ContAngles
  ) %>%
  #    group_by(Nacionalitat_Angles) %>%
  #    summarise_all(sum) %>%
  ungroup()

head(my_data5b)


```

## Evolució d'usuaris Global per categories

```{r Evolució Mensual Global per categories}

# ggplot2 chart
# Get the data selected
my_data7d <- my_data %>% 
  count(Mes,
        Categoria,
        wt = NULL,
        sort = FALSE)

## First look at a quick and dirty version of the future ggplot2 chart (prior to customizations)
#qplot(data=my_data7d, x=Mes, geom="bar") 

# Basic barplot with ggplot
ggplot.n.mes <- ggplot(data=my_data7d, aes(x=Mes, y=n, fill=Categoria)) +
  geom_bar(stat="identity")


if (crear.png.ggplot.barchart.n.mes == TRUE) {
  ggsave(paste0(anydades, ".barchart.n.mes.png"),
       plot = ggplot.n.mes,
       width = 15, height = 8, units = "cm", scale=2,
       path=file.path(getwd(), imgpath) 
       )
}

if (mostrar.html.ggplot.n.mes == TRUE) {
  # Mostra-ho en pantalla també
  ggplot.n.mes
}

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_break() %>% 
    body_add_par(value = "Evolució mensual Global", style = "heading 1") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_gg(value = ggplot.n.mes, style = "centered") %>%  # afegit via objecte ggplot directament (queda millor i no distorsionat!)
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par("Evolució mensual dels allotjaments", style = "Balloon Text")
  
}

```

## Gènere

```{r Gender of users}
  
  # -------------------------------------------------------------
  my_data5d <- count(my_data, NacionalitatAngles, Genere, wt = NULL, sort = FALSE)
  my_data5d <- tidyr::spread(my_data5d, Genere, n)
  if (length(my_data5d) > 3) {
    colnames(my_data5d)[4] <- "Desconegut"
  } else {
    Desconegut <- rep(NA, length(my_data5d$NacionalitatAngles))
    my_data5d <- cbind(my_data5d, Desconegut)
    my_data5d <- tbl_df(my_data5d)
  }
  
  my_data5d$NacionalitatAngles <- apply(my_data5d, 2, toupper)
  # Add coordinates to the countries from the Dades sheet, using left_join
  my_data5e <- my_data5d %>% left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles"))
  my_data5e <- my_data5e %>%
    # filter(grepl("EUROPA", Continent)) %>%
    select(NacionalitatAngles,
           DONA,
           HOME,
           Desconegut,
           lon,
           lat
    ) %>%
    #    group_by(Nacionalitat_Angles) %>%
    #    summarise_all(sum) %>%
    ungroup()
  
  head(my_data5e)
  
  # Get the basemap ready for the leaflet plot
  library(leaflet.minicharts)
  library(leaflet)
  
  tilesURL <- "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"
  
  basemap <- leaflet(width = "100%", height = "400px") %>%
    addTiles(tilesURL)

  #We now add to the base map a pie chart for each country of origin
  #  colors <- c("#4fc13c", "lightyellow", "#cccccc")
  colors <- c("pink", "lightblue", "lightyellow")
  
  leaflet.gender <- basemap %>%
    addMinicharts(
      my_data5e$lon, my_data5e$lat,
      type = "pie",
      chartdata = my_data5e[, c("DONA", "HOME", "Desconegut")], 
      fillColor = "white",
      colorPalette = colors, 
      transitionTime = 0,
      legend=TRUE,
      legendPosition = "topright"
  )
  
  if (crear.html.leaflet.gender == TRUE) {
    saveWidget(leaflet.gender, file=file.path(getwd(), htmlpath, paste0(anydades, ".leaflet.gender.html")), selfcontained=TRUE) 
  }
  webshot(file.path(getwd(), htmlpath, paste0(anydades, ".leaflet.gender.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".leaflet.gender.png")),
        delay=0.5, selector="#htmlwidget_container")
  
  if (mostrar.html.leaflet.gender == TRUE) {
    leaflet.gender
  }

  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par(value = "Gènere", style = "heading 1") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".leaflet.gender.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par("Blau: Homes; Rosa: Dones. Groc: Desconegut", style = "Balloon Text")
    
  }
  
```

## Nuclis familiars

```{r Membres de les Unitats Familiars}
# Plot Map Using rworldmap

  my_mapped_data <- joinCountryData2Map(my_data, joinCode = "NAME", 
                                     nameJoinColumn = "NacionalitatAngles")

  # The par command only needs to be performed once in the session and just makes sure that all the available space in the window is used to display the map.
  par(mai=c(0,0,0.2,0),xaxs="i",yaxs="i")

  my_mapped_data$Membres <- as.numeric(my_mapped_data$Membres)
  
#  png(filename=file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.png")), width=1200, height=600, units="px")
#  png(filename=file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.png")))
  # Plot as svg
  svglite(file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.svg")), width = 12, height = 6)

  
  worldmap.familysize <- mapCountryData(my_mapped_data, 
                 nameColumnToPlot = "Membres", 
                 catMethod="pretty",
                 colourPalette="heat", 
                 mapTitle = "", 
                 oceanCol = "lightblue",
                 missingCountryCol = "white")
  
  dev.off()

  # Redo as png
  png(file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.png")), width=1200, height=700, units="px")
  worldmap.familysize <- mapCountryData(my_mapped_data, 
                 nameColumnToPlot = "Membres", 
                 catMethod="pretty",
                 colourPalette="heat", 
                 mapTitle = "", 
                 oceanCol = "lightblue",
                 missingCountryCol = "white")
  dev.off()
  
  # Pending-2
  # =======================================================
  # Improve type of chart with the thematic maps package
  # See: https://github.com/mtennekes/tmap
  # =======================================================
  # 
  #
  #   if (!require("tmap")) install.packages("tmap")


  # =======================================================
  # Add svgPanZoom capabilities to standard Plots
  # See: https://github.com/timelyportfolio/svgPanZoom
  # =======================================================
  svgPanZoom(
    svglite:::inlineSVG(
      worldmap.familysize <- mapCountryData(my_mapped_data, 
                                                 nameColumnToPlot = "Membres", 
                                                 catMethod="pretty",
                                                 colourPalette="heat", 
                                                 mapTitle = "Número de Membres de la Unitat Familiar", 
                                                 oceanCol = "lightblue",
                                                 missingCountryCol = "white")
    )
  )
  
  # render it into a bitmap array
  bitmap <- rsvg(file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.svg")))
  dim(bitmap)
  ## [1] 504 720   4

  # write to format
  png::writePNG(bitmap, 
                file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize_writepng.png")),
                dpi = 144)
  rsvg_png(file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.svg")),
           file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize_rsvg.png")),
           width = 1600) # If you only set width OR height, the image will be scaled keeping aspect ratio


  # Redimensionar mantenint proporcions amb imagemagick
  my_image <- image_read(file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.png")))
  image_info(my_image)
  # Trim image
  my_image_trimmed <- image_trim(my_image)
  image_info(my_image_trimmed)
  image_write(my_image_trimmed, path = file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize_trimmed.png")))
  # Re-scale image
  my_image_scaled <- image_scale(my_image_trimmed, "2000") # width to 2000px and height proportional to keep aspect ratio
  image_write(my_image_scaled, path = file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize_2000px.png")))
           
  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par(value = "Nuclis familiars", style = "heading 1") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par(value = "D'on són les famílies més nombroses o els individus sols?", style = "heading 2") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      #  body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".worldmap.familysize_2000px.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par("Nombre d´individus a cada nucli familiar", style = "Balloon Text")
    
  }
  
  
```

### Taula Resum

```{r Taula Resum Mida Unitats Familiars}
pt.membres.t <- rpivotTable(
  data = my_data, 
  rows = c("Nacionalitat"), 
  cols=c("Categoria"), 
  vals = "Membres", 
  aggregatorName = "Average", 
  width="1200px", 
  height="800px",   
#  inclusions = list( Categoria = list("NO CONSTA")),
#  exclusions = list( Mes = list( "2018-01")),
  rendererName = "Heatmap"
  )
frameWidget(pt.membres.t)

if (crear.html.pt.membres.t == TRUE) {
  saveWidget(pt.membres.t, file=file.path(getwd(), htmlpath, paste0(anydades, ".pt.membres.t.html")), selfcontained=TRUE) 
}
webshot(file.path(getwd(), htmlpath, paste0(anydades, ".pt.membres.t.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".pt.membres.t.png")),
#        delay=0.5, selector=".pvtUi") # to get both the heatmap table and buttons of variables in rows and columns surrounding it
        delay=0.5, selector=".pvtRendererArea") # to get only the heatmap table with results

if (mostrar.html.pt.membres.t == TRUE) {
  pt.membres.t
}

  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par(value = "D'on són les famílies més nombroses", style = "heading 2") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".pt.membres.t.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("La intensitat del color vermell és proporcional a la suma de casos de cada tipus", style = "Balloon Text")
    
  }

```


## Regim Allotjament
Pensió Completa
Mitja pensió
Allotjament només

### Resum

```{r Resum}

# ggplot2 chart
# Get the data selected
my_data7f <- my_data %>% 
  count(REGIM,
        wt = NULL,
        sort = FALSE) %>%
  filter(!is.na(REGIM)) 
# Afegir fila a sota amb totals
my_data7f.t <- rbind(my_data7f,
      c("*** TOTALS ***", margin.table(as.matrix(my_data7f$n), 2))
)

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_break() %>% 
    body_add_par(value = "Règim Allotjament", style = "heading 1") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par(value = "Resum", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_table(my_data7f.t, style = "table_template")
  
}

```

### Gràfic de barres de Règim Allotjament

```{r Gràfic de barres de Règim Allotjament, echo=TRUE}

# Gràfic de barres ara
# ----------------------------------------

# .........................................................
## First look at a quick and dirty version of the future ggplot2 chart (prior to customizations)
#qplot(data=my_data7f, x=REGIM, geom="identity") 

# Basic barplot with ggplot
ggplot.regim.allotjament <- ggplot(data=my_data7f, aes(x=REGIM, y=n)) +
  geom_bar(stat="identity") +
  #scale_x_discrete(breaks = NULL) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  geom_text(aes(label=n), vjust=-0.2, color="blue", size=4.5) +
  labs(x="Règim Allotjament", y="N") + 
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, vjust=0.5, size=8),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=10),
        axis.title.y = element_text(angle = 0, hjust = 0.5, vjust=0.5, size=12),
        legend.position = "top",
        legend.title = element_text(size=12),
        legend.text = element_text(size=10)
        )

if (crear.png.ggplot.regim.allotjament == TRUE) {
  ggsave(paste0(anydades, ".barchart.ra.png"),
       plot = ggplot.regim.allotjament,
       width = 15, height = 8, units = "cm", scale=2,
       path=file.path(getwd(), imgpath) 
       )
}

if (mostrar.ggplot.sa == TRUE) {
  # Mostra-ho en pantalla també
  ggplot.regim.allotjament
}

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    #  body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".barchart.ra.png")), width = 6, height = 3, style = "centered")
    body_add_gg(value = ggplot.regim.allotjament, style = "centered") %>%  # afegit via objecte ggplot directament (queda millor i no distorsionat!)
    body_add_par("", style = "Normal") # blank paragraph
  
}

```

### Evolució mensual i Totals

```{r Evolució mensual i Totals, echo=TRUE}


my_data7d <- my_data %>% 
      count(REGIM,
            Categoria, 
            Mes,
            wt = NULL, sort = FALSE)

# Option 1) Create the pivot table and save html on disk
# .......................................................
#pt <- rpivotTable(my_data7d)
pt.regim.allotjament.t <- rpivotTable(
  data = my_data7d, 
  rows = c("Mes"), 
  cols=c("REGIM"), 
  vals = "n", 
  aggregatorName = "Sum", 
  width="1200px", 
  height="800px",   
#  inclusions = list( Categoria = list("NO CONSTA")),
#  exclusions = list( Mes = list( "2018-01")),
  rendererName = "Heatmap"
  )
frameWidget(pt.regim.allotjament.t)

if (crear.html.pt.regim.allotjament.t == TRUE) {
  saveWidget(pt.regim.allotjament.t, file=file.path(getwd(), htmlpath, paste0(anydades, ".pt.REGIM.t.html")), selfcontained=TRUE) 
}
webshot(file.path(getwd(), htmlpath, paste0(anydades, ".pt.REGIM.t.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".pt.REGIM.t.png")),
#        delay=0.5, selector=".pvtUi") # to get both the heatmap table and buttons of variables in rows and columns surrounding it
        delay=0.5, selector=".pvtRendererArea") # to get only the heatmap table with results

if (mostrar.html.pt.regim.allotjament.t == TRUE) {
  pt.regim.allotjament.t
}

# #Codi extra per a extreure taula de dades de resultats, fent "web scraping"" amb rvest
# # No va no sé per què. Aturo la prova, per ara.
# url_base <- file.path(getwd(), htmlpath, paste0(anydades, ".pt.REGIM.t.html"))
# #class(read_html(url_base))
# webpage <- read_html(url_base) %>%
#   html_nodes(".pvtTable") 
#   # html_table(fill = TRUE) %>% 
#   # # Turns out there are two tables in an rpivotTable, we want the second
#   # .[[2]]
# #  html_nodes(".pvtTable") 

# Opció 2) Segon intent de crear el heatmap table. Ara amb el paquet formattable
# ...........................................
 my_data7d.t <- my_data %>% 
       count(Mes,
             REGIM,
             wt = NULL, sort = FALSE) %>%
   tidyr::spread(REGIM, n)

 # # Make heatmap-like table  
 # formattable(my_data7d.t, list(area(col = colnames(my_data7d.t)[-1])
 #                             ~ color_tile("transparent", "pink")
 #                             )
 #             )
 
 # add margin table. since any NA make the whole sum NA, we need to remove NA's first so that we get the right marginal sums
 # impute(.tbl, .na, ...) (from package tidyimpute)
 # margin.table(as.matrix(impute(my_data7d.t[,-1], 0)), 2)
 # margin.table(as.matrix(impute(my_data7d.t[,-1], 0)), 1)
 
 # Afegir fila i columna amb totals
 my_data7d.t2 <- cbind(rbind(my_data7d.t[,1], "*** TOTALS ***"), 
                       as_tibble(addmargins(as.matrix(impute(my_data7d.t[,-1], 0)))))
 # Fes nova heatmap-like table amb totals marginals, en objecte formattable
 my_data7d.ft <- formattable(my_data7d.t2, list(area(col = colnames(my_data7d.t2)[-1])
                             ~ color_tile("transparent", "red")
                             )
             )
 # Display the formattable object on screen
 my_data7d.ft
 
 # Convert the formattable into a DT object so that it can be saved to disk
 my_data7d.dt <- as.datatable(my_data7d.ft, 
                              options = list(pageLength = 15, 
                                             dom = 't'))  # dom=t is for removing the search (filter) box
 
if (crear.html.dt.regim.allotjament.month == TRUE) {
 #Save html with table to disk
 htmlwidgets::saveWidget(my_data7d.dt, file=file.path(getwd(), htmlpath, paste0(anydades, ".formatdatatable.regim.allotjament.month.html")), selfcontained=TRUE) 
 # convert into responsive widget
 my_data7d.dt <- frameWidget(my_data7d.dt)
}

 # Make screenshot out of that heatmap-like table, just in case, for easy adding into word document report
  webshot(file.path(getwd(), htmlpath, paste0(anydades, ".formatdatatable.regim.allotjament.month.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.regim.allotjament.month.png")),
        delay=0.5)
  
  # Read saved image
  my_image <- image_read(file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.regim.allotjament.month.png")))
  # Trim image
  my_image_trimmed <- image_trim(my_image)
  # Save trimmed image again to disk
  image_write(my_image_trimmed, path = file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.regim.allotjament.month.trimmed.png")))

  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par(value = "Evolució mensual i Totals", style = "heading 2") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_table(my_data7d.t2, style = "table_template") %>%
      #  body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".pt.REGIM.t.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.regim.allotjament.month.trimmed.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("La intensitat del color vermell és proporcional a la suma de casos de cada tipus", style = "Balloon Text")
    
  }
  
```

## Durada

Evolució mensual i Totals

```{r Durada - Evolució mensual i Totals, echo=TRUE}

# Option 1) Create the pivot table and save html on disk
# .......................................................
#pt <- rpivotTable(my_data7d)
pt.durada.t <- rpivotTable(
  data = my_data, 
  rows = c("Mes"), 
  cols=c("Categoria"), 
  vals = "DIES", 
  aggregatorName = "Sum", 
  width="1200px", 
  height="800px",   
#  inclusions = list( Categoria = list("NO CONSTA")),
#  exclusions = list( Mes = list( "2018-01")),
  rendererName = "Heatmap"
  )
frameWidget(pt.durada.t)

if (crear.html.pt.durada.t == TRUE) {
  saveWidget(pt.durada.t, file=file.path(getwd(), htmlpath, paste0(anydades, ".pt.DURADA.t.html")), selfcontained=TRUE) 
}
webshot(file.path(getwd(), htmlpath, paste0(anydades, ".pt.DURADA.t.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".pt.DURADA.t.png")),
#        delay=0.5, selector=".pvtUi") # to get both the heatmap table and buttons of variables in rows and columns surrounding it
        delay=0.5, selector=".pvtRendererArea") # to get only the heatmap table with results

if (mostrar.html.pt.durada.t == TRUE) {
  pt.durada.t
}

  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par(value = "Evolució mensual i Totals", style = "heading 2") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".pt.DURADA.t.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("La intensitat del color vermell és proporcional a la suma de casos de cada tipus", style = "Balloon Text")
    
  }
  
```

## Nacionalitats

```{r Nacionalitats}

# Get the data selected
my_data7a <- my_data %>% 
  count(NacionalitatAngles,
        Categoria,
        Mes,
        AdultMenor,
        Genere,
        wt = NULL,
        sort = FALSE) %>%
  filter(!is.na(NacionalitatAngles)
         )
# Get the top10 also
    my_data7a.top10 <-  my_data %>% 
          count(Nacionalitat, 
                wt = NULL, sort = TRUE) %>%
          filter(!is.na(Nacionalitat)) %>%
          filter(Nacionalitat != "NO CONSTA") %>%
          slice(1:10)

# Afegir fila a sota amb totals
my_data7a.top10 <- rbind(my_data7a.top10,
      c("*** TOTALS ***", margin.table(as.matrix(my_data7a$n), 2))
)

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_break() %>% 
    body_add_par(value = "Nacionalitats per continents", style = "heading 1") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par(value = "Nacionalitats més freqüents", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_table(my_data7a.top10, style = "table_template") %>%
    body_add_par(value = "10 Nacionalitats més freqüents", style = "table title")
  
}

# Afegir Continent
my_data7a$NacionalitatAngles <- apply(my_data7a, 2, toupper)
# Add coordinates to the countries from the Dades sheet, using left_join
my_data7aCont <- my_data7a %>% left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles"))

my_data7aCont <- my_data7aCont %>%
  # filter(grepl("EUROPA", Continent)) %>%
  rename(Continent = ContAngles) %>%
  select(NacionalitatAngles,
         Categoria,
         Mes,
         AdultMenor,
         Genere,
         n,
         lon,
         lat,
         Continent
  ) %>%
  #    group_by(Nacionalitat_Angles) %>%
  #    summarise_all(sum) %>%
  ungroup()


```



```{r Nacionalitats per Categories - ggplot2 chart}

# ggplot with params suitable for displaying on screen and for  officer::body_add_gg
# --------------------------------------------------------------
# Basic barplot with ggplot and ggplotly
ggplot.nacionalitat <- ggplot(data=my_data7aCont, aes(x=NacionalitatAngles, fill=Categoria, y=n)) +
  geom_bar(stat="identity") +
#  geom_text(aes(label=n), vjust=1.6, color="white", size=6.5) +
#  geom_text(aes(label=n), vjust=-0.2, color="blue", size=2.5) +
  labs(x="Nacionalitat", y="N") + 
  #scale_fill_discrete(name="Continents") + # Legend Title
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5, size=8),
        axis.text.y = element_text(size=8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(angle = 90, hjust = 0.5, vjust=0.5, size=10),
        legend.position = "top",
        legend.title = element_text(size=12),
        legend.text = element_text(size=10)
        )

# Mostra-ho en pantalla també
ggplot.nacionalitat

if (crear.png.ggplot.nacionalitat == TRUE) {
  # Grava a disc per si un cas també
  ggsave(paste0(anydades, ".barchart.nacionality.png"),
       plot = ggplot.nacionalitat,
       width = 30, height = 10, units = "cm", scale=2,
       path=file.path(getwd(), imgpath) 
       )
}

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_par(value = "Totals i per països", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    #body_add_img(src=file.path(getwd(), imgpath, paste0(anydades,".barchart.nacionality.png")),width=6,height=3,style="centered") %>% # Afegit via png de disc
    #  body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_gg(value = ggplot.nacionalitat, style = "centered")   # afegit via objecte ggplot directament (queda millor i no distorsionat!)
  
}


```


```{r Versió ggplotly a partir del ggplot chart}

# Convertir a versió plotly del gràfic de ggplot
ggplotly.nacionalitat <- ggplotly(p = ggplot.nacionalitat)

if (crear.html.ggplotly.nacionalitat == TRUE) {
  htmlwidgets::saveWidget(ggplotly.nacionalitat, file=file.path(getwd(), htmlpath, paste0(anydades, ".ggplotly.nacionalitat.html")), selfcontained=TRUE) 
}

mostrar.html.ggplotly.nacionalitat <- F
if (mostrar.html.ggplotly.nacionalitat == TRUE) {
  ggplotly.nacionalitat
}

```

### Gràfic alternatiu (treemap)

```{r Gràfic alternatiu (treemap)}

# Get the data selected
my_data7b <- my_data %>% 
  count(NacionalitatAngles, 
        wt = NULL, sort = FALSE) %>%
  filter(!is.na(NacionalitatAngles))

# Afegir Continent
my_data7b$NacionalitatAngles <- apply(my_data7b, 2, toupper)
# Add coordinates to the countries from the Dades sheet, using left_join
my_data7bCont <- my_data7b %>% 
  left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles")) %>%
  rename(Continent = ContAngles) %>%
  select(NacionalitatAngles,
         n,
         Continent
  ) %>%
  ungroup()

  # basic treemaps
    png(filename=file.path(getwd(), imgpath, paste0(anydades, ".treemap.nacionality.png")), width=1200, height=600, units="px")
    p2017.nacio=treemap(my_data7bCont,
                        index=c("Continent","NacionalitatAngles"),
                        vSize="n",
                        type="index",
                        title="Nacionalitats d´Usuaris de l´Allotjament en Hostals i Pensions",
                        overlap.labels=1,
                        force.print.labels=TRUE,
                        aspRatio=2,
                        fontsize.title = 20,
                        fontsize.labels = 16,
                        fontsize.legend = 18,
                        align.labels=c("center", "center")
    )  
    dev.off()
    
    if (crear.informe.word == TRUE) {
      
      # Afegir contingut a l'informe en Word
      my_doc <- my_doc %>% 
        body_add_break() %>% 
        body_add_par(value = "Gràfic alternatiu", style = "heading 2") %>% 
        body_add_par("", style = "Normal") %>% # blank paragraph
        body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".treemap.nacionality.png")), width = 6, height = 3, style = "centered") %>% 
        body_add_par("", style = "Normal") %>% # blank paragraph
        body_add_par("Mida de l'àrea proporcional al nombre", style = "Balloon Text")
      
    }  
    
```

## Motiu Allotjament

```{r Motiu Allotjament}

# Get the data selected
my_data9 <- my_data %>% 
  count(MotiuAllotjament,
        Categoria,
        wt = NULL,
        sort = FALSE) %>%
  filter(!is.na(MotiuAllotjament)
         )

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par(value = "Motiu Alotjament", style = "heading 2") %>% 
    body_add_par("", style = "Normal") # blank paragraph

  
}

# ggplot with params suitable for displaying on screen and for  officer::body_add_gg
# --------------------------------------------------------------
# Basic barplot with ggplot and ggplotly
ggplot.motiu <- ggplot(data=my_data9, aes(x=MotiuAllotjament, fill=Categoria, y=n)) +
  geom_bar(stat="identity") +
#  geom_text(aes(label=n), vjust=1.6, color="white", size=3.5) +
#  geom_text(aes(label=n), vjust=-0.2, color="blue", size=2.5) +
  labs(x="Motiu de l'allotjament", y="N") + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
#  scale_y_log10() +
#  scale_y_continuous(breaks=c(0,1,10,100,1000,10000), trans="log1p") +
    #scale_fill_discrete(name="Continents") + # Legend Title
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, vjust=0.5, size=8),
        axis.text.y = element_text(size=8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(angle = 90, hjust = 0.5, vjust=0.5, size=10),
        legend.position = "top",
        legend.title = element_text(size=12),
        legend.text = element_text(size=10)
        )

# Mostra-ho en pantalla també
ggplot.motiu

if (crear.png.ggplot.motiu == TRUE) {
  # Grava a disc per si un cas també
  ggsave(paste0(anydades, ".barchart.motiu.png"),
       plot = ggplot.motiu,
       width = 30, height = 10, units = "cm", scale=1,
       path=file.path(getwd(), imgpath) 
       )
}

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_par(value = "Motius de l'Allotjament", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    #body_add_img(src=file.path(getwd(), imgpath, paste0(anydades,".barchart.nacionality.png")),width=6,height=3,style="centered") %>% # Afegit via png de disc
    #  body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_gg(value = ggplot.motiu, style = "centered")   # afegit via objecte ggplot directament (queda millor i no distorsionat!)
  
}


```

```{r Idem de Motius en taula}
 my_data9.t <- my_data9 %>% 
   tidyr::spread(Categoria, n)

 # # Make heatmap-like table  
 # formattable(my_data7d.t, list(area(col = colnames(my_data7d.t)[-1])
 #                             ~ color_tile("transparent", "pink")
 #                             )
 #             )
 
 # add margin table. since any NA make the whole sum NA, we need to remove NA's first so that we get the right marginal sums
 # impute(.tbl, .na, ...) (from package tidyimpute)
 # margin.table(as.matrix(impute(my_data7d.t[,-1], 0)), 2)
 # margin.table(as.matrix(impute(my_data7d.t[,-1], 0)), 1)
 
 # Afegir fila i columna amb totals
 my_data9.t2 <- cbind(rbind(my_data9.t[,1], "*** TOTALS ***"), 
                       as_tibble(addmargins(as.matrix(impute(my_data9.t[,-1], 0)))))
 # Fes nova heatmap-like table amb totals marginals, en objecte formattable
 my_data9.ft <- formattable(my_data9.t2, list(area(col = colnames(my_data9.t2)[-1])
                             ~ color_tile("transparent", "red")
                             )
             )
 # Display the formattable object on screen
 my_data9.ft
 
 # Convert the formattable into a DT object so that it can be saved to disk
 my_data9.dt <- as.datatable(my_data9.ft, 
                              options = list(pageLength = 15, 
                                             dom = 't'))  # dom=t is for removing the search (filter) box
 
if (crear.html.dt.motiu == TRUE) {
 #Save html with table to disk
 htmlwidgets::saveWidget(my_data9.dt, file=file.path(getwd(), htmlpath, paste0(anydades, ".formatdatatable.motiu.html")), selfcontained=TRUE) 
}

 # Make screenshot out of that heatmap-like table, just in case, for easy adding into word document report
  webshot(file.path(getwd(), htmlpath, paste0(anydades, ".formatdatatable.motiu.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.motiu.png")),
        delay=0.5)
  
  # Read saved image
  my_image <- image_read(file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.motiu.png")))
  # Trim image
  my_image_trimmed <- image_trim(my_image)
  # Save trimmed image again to disk
  image_write(my_image_trimmed, path = file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.motiu.trimmed.png")))

  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par(value = "Motius de l'Allotjament per categoria d'usuaris", style = "heading 2") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_table(my_data9.t2, style = "table_template") %>%
      #  body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".pt.REGIM.t.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.motiu.trimmed.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("La intensitat del color vermell és proporcional a la suma de casos de cada tipus", style = "Balloon Text")
    
  }
```

## Grups d'Edat

```{r Age group of users}

  # Map Age group of users in pie charts over the world map
  # -------------------------------------------------------------
  my_data6 <- count(my_data, NacionalitatAngles, AdultMenor, wt = NULL, sort = FALSE)
  my_data6b <- tidyr::spread(my_data6, AdultMenor, n)
  if (length(my_data6b) > 3) {
    colnames(my_data6b)[4] <- "desconegut"
  } else {
    desconegut <- rep(NA, length(my_data6b$NacionalitatAngles))
    my_data6b <- cbind(my_data6b, desconegut)
    my_data6b <- tbl_df(my_data6b)
  }
  
  my_data6b$NacionalitatAngles <- apply(my_data6b, 2, toupper)
  # Add coordinates to the countries from the Dades sheet, using left_join
  my_data6c <- my_data6b %>% left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles"))
  
  my_data6d <- my_data6c %>%
    # filter(grepl("EUROPA", Continent)) %>%
    select(NacionalitatAngles,
           ADULT,
           MENOR,
           desconegut,
           lon,
           lat
    ) %>%
    #    group_by(Nacionalitat_Angles) %>%
    #    summarise_all(sum) %>%
    ungroup()
  
  


  
  head(my_data6d)
  
  
  colors <- c("green", "lightgreen", "orange")
  
  leaflet.agegroups <- basemap %>%
    addMinicharts(
      my_data6d$lon, my_data6d$lat,
      type = "pie",
      chartdata = my_data6d[, c("ADULT", "MENOR", "desconegut")], 
      fillColor = "white",
      colorPalette = colors, 
      transitionTime = 0,
      legend=TRUE,
      legendPosition = "topright"
    )

    if (crear.html.leaflet.agegroups == TRUE) {
      saveWidget(leaflet.agegroups, file=file.path(getwd(), htmlpath, paste0(anydades, ".leaflet.agegroups.html")), selfcontained=TRUE) 
    }

    webshot(file.path(getwd(), htmlpath, paste0(anydades, ".leaflet.agegroups.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".leaflet.agegroups.png")),
        delay=0.5, selector = "#htmlwidget_container")

    if (crear.informe.word == TRUE) {
      
      # Afegir contingut a l'informe en Word
      my_doc <- my_doc %>% 
        body_add_par(value = "Distribució d'adults i menors per països", style = "heading 2") %>% 
        body_add_par("", style = "Normal") %>% # blank paragraph
        body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".leaflet.agegroups.png")), width = 6, height = 3, style = "centered") %>% 
        body_add_par("", style = "Normal") %>% # blank paragraph
        body_add_par("Verd fosc: Adult | Verd clar: Menor | Taronja: Desconegut", style = "Balloon Text")
      
    }

  # Pending-1
  # =======================================================
  # Test adding an easy interface to allow changing htmlwidget on the go with manipulatewidget
  # See: https://github.com/rte-antares-rpackage/manipulateWidget
  # =======================================================
  # 
  #
  #   if (!require("manipulateWidget")) install.packages("manipulateWidget")

```



### Orígens dels menors

```{r Orígens dels menors}

# ggplot2 chart
# Get the data selected
my_data7e <- my_data %>% 
  count(AdultMenor,
        NacionalitatAngles,
        Categoria,
        wt = NULL,
        sort = FALSE) %>%
  filter(AdultMenor == "MENOR")


# Afegir Continent
my_data7e$NacionalitatAngles <- apply(my_data7e, 2, toupper)[,2]
# Add coordinates to the countries from the Dades sheet, using left_join
my_data7eCont <- my_data7e %>% 
  left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles")) %>%
  rename(Continent = ContAngles) %>%
  select(AdultMenor,
         NacionalitatAngles,
         Categoria,
         n,
         Continent
  ) %>%
  ungroup()

## First look at a quick and dirty version of the future ggplot2 chart (prior to customizations)
#qplot(data=my_data7e, x=NacionalitatAngles, geom="bar") 

# Basic barplot with ggplot
ggplot.nacio.menors <- ggplot(data=my_data7eCont, aes(x=NacionalitatAngles, color=Categoria, fill=Categoria, y=n)) +
  geom_bar(stat="identity") +
  #scale_x_discrete(breaks = NULL) +
  #geom_text(aes(label=n), vjust=-0.2, color="blue", size=3.5) +
  #geom_text(aes(label=n), vjust=1.6, color="white", size=3.5) +
  labs(x="Nacionalitat dels Menors", y="N") + 
#  coord_cartesian(ylim = c(-0, 65)) +
  #scale_fill_discrete(name="Continents") + # Legend Title
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5, size=12),
        axis.text.y = element_text(size=12),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(angle = 0, hjust = 0.5, vjust=0.5, size=12),
        legend.position = "top",
        legend.title = element_text(size=12),
        legend.text = element_text(size=10)
        )

if (crear.png.ggplot.nacio.menors == TRUE) {
  ggsave(paste0(anydades, ".barchart.nacio.menors.png"),
       plot = ggplot.nacio.menors,
       width = 15, height = 8, units = "cm", scale=2,
       path=file.path(getwd(), imgpath) 
       )
}

if (mostrar.html.ggplot.nacio.menors == TRUE) {
  # Mostra-ho en pantalla també
  ggplot.nacio.menors
}

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_break() %>% 
    body_add_par(value = "Orígens dels menors", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    #  body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".barchart.nacio.menors.png")), width = 6, height = 3, style = "centered") %>% 
    body_add_gg(value = ggplot.nacio.menors, style = "centered") %>%  # afegit via objecte ggplot directament (queda millor i no distorsionat!)
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par("Nacionalitats dels menors allotjats en Hostals i Pensions", style = "Balloon Text")
  
}

```


```{r Idem dels Origens dels menors en taula}
 my_data7e.t <- my_data7e[,-1] %>% 
   tidyr::spread(Categoria, n)

 # # Make heatmap-like table  
 # formattable(my_data7d.t, list(area(col = colnames(my_data7d.t)[-1])
 #                             ~ color_tile("transparent", "pink")
 #                             )
 #             )
 
 # add margin table. since any NA make the whole sum NA, we need to remove NA's first so that we get the right marginal sums
 # impute(.tbl, .na, ...) (from package tidyimpute)
 # margin.table(as.matrix(impute(my_data7d.t[,-1], 0)), 2)
 # margin.table(as.matrix(impute(my_data7d.t[,-1], 0)), 1)
 
 # Afegir fila i columna amb totals
 my_data7e.t2 <- cbind(rbind(my_data7e.t[,1], "*** TOTALS ***"), 
                       as_tibble(addmargins(as.matrix(impute(my_data7e.t[,-1], 0)))))
 # Fes nova heatmap-like table amb totals marginals, en objecte formattable
 my_data7e.ft <- formattable(my_data7e.t2, list(area(col = colnames(my_data7e.t2)[-1])
                             ~ color_tile("transparent", "red")
                             )
             )
 # Display the formattable object on screen
 my_data7e.ft
 
 # Convert the formattable into a DT object so that it can be saved to disk
  my_data7e.dt <- as.datatable(my_data7e.ft, 
                              options = list(pageLength = 25, 
                                             dom = 't'))  # dom=t is for removing the search (filter) box
 
if (crear.html.dt.origens.menors == TRUE) {
 #Save html with table to disk
 htmlwidgets::saveWidget(my_data7e.dt, file=file.path(getwd(), htmlpath, paste0(anydades, ".formatdatatable.origens.menors.html")), selfcontained=TRUE) 
}

 # Make screenshot out of that heatmap-like table, just in case, for easy adding into word document report
  webshot(file.path(getwd(), htmlpath, paste0(anydades, ".formatdatatable.origens.menors.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.origens.menors.png")),
        delay=0.5)
  
  # Read saved image
  my_image <- image_read(file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.origens.menors.png")))
  # Trim image
  my_image_trimmed <- image_trim(my_image)
  # Save trimmed image again to disk
  image_write(my_image_trimmed, path = file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.origens.menors.trimmed.png")))

  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par(value = "Origens dels Menors Allotjats per categoria d'usuaris", style = "heading 2") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_table(my_data7e.t2, style = "table_template") %>%
      #  body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".pt.REGIM.t.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".formatdatatable.origens.menors.trimmed.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("La intensitat del color vermell és proporcional a la suma de casos de cada tipus", style = "Balloon Text")
    
  }
```


## Refugiats
### Previsió de Sortida - Resum

```{r Refugiats - Previsió de Sortida - Resum}

# ggplot2 chart
# Get the data selected
my_data10 <- my_data %>% 
  filter(Categoria == "Refus-P" | Categoria == "Refus-FP") %>%
  count(PrevisioSortida,
        Categoria,
        wt = NULL,
        sort = FALSE) 
 
 my_data10.t <- my_data10 %>% 
   tidyr::spread(Categoria, n)
  

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_break() %>% 
    body_add_par(value = "Refugiats", style = "heading 1") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par(value = "Previsió de Sortida - Resum", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_table(my_data10.t, style = "table_template")
  
}

```

### Canvis a Situació Programa de Refugiats - Entrades

```{r Canvis a Situació Programa de Refugiats - Entrades}

# Get the data selected
my_data11 <- my_data %>% 
  filter(!is.na(DataIniciAllotjament)) %>%
  filter(Categoria == "Refus-P" | Categoria == "Refus-FP") %>%
  count(Mes,
        Categoria,
        wt = NULL,
        sort = FALSE)

 my_data11.t <- my_data11 %>% 
   tidyr::spread(Categoria, n)
  

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par(value = "Canvis a Situació Programa de Refugiats - Entrades", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_table(my_data11.t, style = "table_template")
  
}




```

### Canvis a Situació Programa de Refugiats - Sortides

```{r Canvis a Situació Programa de Refugiats - Sortides}


# Get the data selected
my_data12 <- my_data %>% 
  filter(!is.na(DataSortida)) %>%
  filter(Categoria == "Refus-P" | Categoria == "Refus-FP") %>%
  count(Mes,
        Categoria,
        wt = NULL,
        sort = FALSE)

 my_data12.t <- my_data12 %>% 
   tidyr::spread(Categoria, n)
  

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par(value = "Canvis a Situació Programa de Refugiats - Sortides", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_table(my_data12.t, style = "table_template")
  
}




```

### Situació de Refugiats Fora de Programa Estatal

```{r Situació de Refugiats Fora de Programa Estatal}

# Get the data selected
my_data13 <- my_data %>% 
  filter(Categoria == "Refus-FP") %>%
  count(Mes,
        SituacioProgramaRefugiats,
        wt = NULL,
        sort = FALSE)

 my_data13.t <- my_data13 %>% 
   tidyr::spread(SituacioProgramaRefugiats, n)
 colnames.short <- stringr::str_replace_all(colnames(my_data13.t)[-1], "Fora de programa. ", "")
 colnames(my_data13.t)[-1] <- colnames.short
  
 my_data13.t <- cbind(rbind(my_data13.t[,1], "TOTAL"), 
                       as_tibble(addmargins(as.matrix(impute(my_data13.t[,-1], 0))))
                      ) 
my_data13.t <- rename(my_data13.t, TOTAL = Sum)

if (crear.informe.word == TRUE) {
  
  # Afegir contingut a l'informe en Word
  my_doc <- my_doc %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_par(value = "Situació de Refugiats Fora de Programa Estatal", style = "heading 2") %>% 
    body_add_par("", style = "Normal") %>% # blank paragraph
    body_add_table(my_data13.t, style = "table_template")
  
}




```


## Despesa
Per mesos i categoria d'usuaris

```{r Despesa Per mesos i categories dels usuaris}

pt.despesa.t <- rpivotTable(
  data = my_data, 
  rows = c("Mes", "Categoria"), 
  cols=c("REGIM"), 
  vals = "TOTAL", 
  aggregatorName = "Sum", 
  width="1200px", 
  height="800px",   
#  inclusions = list( Categoria = list("NO CONSTA")),
#  exclusions = list( Mes = list( "2018-01")),
  rendererName = "Heatmap"
  )
frameWidget(pt.despesa.t)

if (crear.html.pt.despesa.t == TRUE) {
  saveWidget(pt.despesa.t, file=file.path(getwd(), htmlpath, paste0(anydades, ".pt.despesa.t.html")), selfcontained=TRUE) 
}
webshot(file.path(getwd(), htmlpath, paste0(anydades, ".pt.despesa.t.html")),
        file=file.path(getwd(), imgpath, paste0(anydades, ".pt.despesa.t.png")),
#        delay=0.5, selector=".pvtUi") # to get both the heatmap table and buttons of variables in rows and columns surrounding it
        delay=0.5, selector=".pvtRendererArea") # to get only the heatmap table with results

if (mostrar.html.pt.despesa.t == TRUE) {
  pt.despesa.t
}

  if (crear.informe.word == TRUE) {
    
    # Afegir contingut a l'informe en Word
    my_doc <- my_doc %>% 
      body_add_break() %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_par(value = "Evolució de la despesa per categoria d'usuaris", style = "heading 2") %>% 
      body_add_par("", style = "Normal") %>% # blank paragraph
      body_add_img(src = file.path(getwd(), imgpath, paste0(anydades, ".pt.despesa.t.png")), width = 6, height = 3, style = "centered") %>% 
      body_add_par("La intensitat del color vermell és proporcional a la suma de casos de cada tipus", style = "Balloon Text")
    
  }

```


## Escriure informe en Word

```{r esborrany informe en word}
if (crear.informe.word == TRUE) {
  
  print(my_doc, target=file.path(getwd(),
                                 docpath,
                                 paste0(paste0(anydades, ".Allotjament_HostalsPensions_v"), 
                                        format(Sys.Date(), 
                                               format="%y%m%d"
                                        ),
                                        ".docx")
                                 )
  )
  invisible()
}

```

## Llistat de paquets emprats

```{r session info}

sessionInfo()

```

```{r Codi per finalitzar la Paral·lelització eventual de la feina}

stopCluster(cl) # shut down the cluster

```

```{r Store session info (package versions, etc) in the logs folder}
###################################################
# Store session info (package versions, etc) in the logs folder
###################################################
sink(file.path(logspath, paste0("log_", format(Sys.Date(), format="%y%m%d"), ".txt")))
cat("Sys.info() : \n")
cat("--------------------\n")
data.frame(Sys.info())
cat("\n\nsessionInfo() : \n")
cat("--------------------\n")
sessionInfo()
cat("--------------------\n")
# Show overall duration of the run
duration_all <- Sys.time()-start_all;
duration_all_msg <- paste(duration_all, attr(duration_all, "units"), sep=" ");
cat(paste0("\nDurantion of the whole run: ", duration_all_msg));

sink()
```

